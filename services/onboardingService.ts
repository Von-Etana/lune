// Onboarding Service - Manages first-time user experience and tour state

const STORAGE_KEYS = {
    TOUR_COMPLETED: 'lune_tour_completed',
    TOUR_SKIPPED: 'lune_tour_skipped',
    FEATURE_HIGHLIGHTS_SEEN: 'lune_feature_highlights_seen',
    ONBOARDING_PROGRESS: 'lune_onboarding_progress',
    FIRST_LOGIN_DATE: 'lune_first_login',
    TIPS_DISMISSED: 'lune_tips_dismissed'
};

interface OnboardingProgress {
    profileCompleted: boolean;
    firstAssessmentTaken: boolean;
    firstCertificateEarned: boolean;
    videoUploaded: boolean;
    tourCompleted: boolean;
}

interface UserOnboardingState {
    isFirstTimeUser: boolean;
    showTour: boolean;
    progress: OnboardingProgress;
    seenFeatures: string[];
    dismissedTips: string[];
}

class OnboardingService {
    private userId: string | null = null;

    /**
     * Initialize onboarding service for a user
     */
    setUserId(userId: string): void {
        this.userId = userId;
    }

    /**
     * Get storage key with user prefix
     */
    private getKey(key: string): string {
        return this.userId ? `${key}_${this.userId}` : key;
    }

    /**
     * Check if user is experiencing the platform for the first time
     */
    isFirstTimeUser(): boolean {
        const firstLogin = localStorage.getItem(this.getKey(STORAGE_KEYS.FIRST_LOGIN_DATE));
        return !firstLogin;
    }

    /**
     * Mark user's first login
     */
    markFirstLogin(): void {
        if (!localStorage.getItem(this.getKey(STORAGE_KEYS.FIRST_LOGIN_DATE))) {
            localStorage.setItem(this.getKey(STORAGE_KEYS.FIRST_LOGIN_DATE), new Date().toISOString());
        }
    }

    /**
     * Check if onboarding tour should be shown
     */
    shouldShowTour(): boolean {
        const completed = localStorage.getItem(this.getKey(STORAGE_KEYS.TOUR_COMPLETED));
        const skipped = localStorage.getItem(this.getKey(STORAGE_KEYS.TOUR_SKIPPED));
        return this.isFirstTimeUser() && !completed && !skipped;
    }

    /**
     * Mark tour as completed
     */
    completeTour(): void {
        localStorage.setItem(this.getKey(STORAGE_KEYS.TOUR_COMPLETED), 'true');
        this.updateProgress({ tourCompleted: true });
    }

    /**
     * Mark tour as skipped
     */
    skipTour(): void {
        localStorage.setItem(this.getKey(STORAGE_KEYS.TOUR_SKIPPED), 'true');
    }

    /**
     * Reset tour (for testing or user preference)
     */
    resetTour(): void {
        localStorage.removeItem(this.getKey(STORAGE_KEYS.TOUR_COMPLETED));
        localStorage.removeItem(this.getKey(STORAGE_KEYS.TOUR_SKIPPED));
    }

    /**
     * Get user's onboarding progress
     */
    getProgress(): OnboardingProgress {
        const stored = localStorage.getItem(this.getKey(STORAGE_KEYS.ONBOARDING_PROGRESS));
        if (stored) {
            return JSON.parse(stored);
        }
        return {
            profileCompleted: false,
            firstAssessmentTaken: false,
            firstCertificateEarned: false,
            videoUploaded: false,
            tourCompleted: false
        };
    }

    /**
     * Update onboarding progress
     */
    updateProgress(updates: Partial<OnboardingProgress>): void {
        const current = this.getProgress();
        const updated = { ...current, ...updates };
        localStorage.setItem(this.getKey(STORAGE_KEYS.ONBOARDING_PROGRESS), JSON.stringify(updated));
    }

    /**
     * Calculate onboarding completion percentage
     */
    getCompletionPercentage(): number {
        const progress = this.getProgress();
        const steps = [
            progress.tourCompleted,
            progress.profileCompleted,
            progress.firstAssessmentTaken,
            progress.firstCertificateEarned,
            progress.videoUploaded
        ];
        const completed = steps.filter(Boolean).length;
        return Math.round((completed / steps.length) * 100);
    }

    /**
     * Check if a feature highlight has been seen
     */
    hasSeenFeature(featureId: string): boolean {
        const seen = this.getSeenFeatures();
        return seen.includes(featureId);
    }

    /**
     * Get all seen feature highlights
     */
    getSeenFeatures(): string[] {
        const stored = localStorage.getItem(this.getKey(STORAGE_KEYS.FEATURE_HIGHLIGHTS_SEEN));
        return stored ? JSON.parse(stored) : [];
    }

    /**
     * Mark a feature as seen
     */
    markFeatureSeen(featureId: string): void {
        const seen = this.getSeenFeatures();
        if (!seen.includes(featureId)) {
            seen.push(featureId);
            localStorage.setItem(this.getKey(STORAGE_KEYS.FEATURE_HIGHLIGHTS_SEEN), JSON.stringify(seen));
        }
    }

    /**
     * Check if a tip has been dismissed
     */
    isTipDismissed(tipId: string): boolean {
        const dismissed = this.getDismissedTips();
        return dismissed.includes(tipId);
    }

    /**
     * Get all dismissed tips
     */
    getDismissedTips(): string[] {
        const stored = localStorage.getItem(this.getKey(STORAGE_KEYS.TIPS_DISMISSED));
        return stored ? JSON.parse(stored) : [];
    }

    /**
     * Dismiss a tip
     */
    dismissTip(tipId: string): void {
        const dismissed = this.getDismissedTips();
        if (!dismissed.includes(tipId)) {
            dismissed.push(tipId);
            localStorage.setItem(this.getKey(STORAGE_KEYS.TIPS_DISMISSED), JSON.stringify(dismissed));
        }
    }

    /**
     * Get full onboarding state
     */
    getFullState(): UserOnboardingState {
        return {
            isFirstTimeUser: this.isFirstTimeUser(),
            showTour: this.shouldShowTour(),
            progress: this.getProgress(),
            seenFeatures: this.getSeenFeatures(),
            dismissedTips: this.getDismissedTips()
        };
    }

    /**
     * Reset all onboarding data (for testing)
     */
    resetAll(): void {
        Object.values(STORAGE_KEYS).forEach(key => {
            localStorage.removeItem(this.getKey(key));
        });
    }

    /**
     * Get next recommended action based on progress
     */
    getNextRecommendedAction(): {
        action: string;
        title: string;
        description: string;
        priority: number;
    } | null {
        const progress = this.getProgress();

        if (!progress.tourCompleted) {
            return {
                action: 'complete_tour',
                title: 'Complete Welcome Tour',
                description: 'Learn how to use the platform effectively',
                priority: 1
            };
        }

        if (!progress.profileCompleted) {
            return {
                action: 'complete_profile',
                title: 'Complete Your Profile',
                description: 'Add your skills, experience, and bio to attract employers',
                priority: 2
            };
        }

        if (!progress.firstAssessmentTaken) {
            return {
                action: 'take_assessment',
                title: 'Take Your First Assessment',
                description: 'Get verified in a skill to earn your first certificate',
                priority: 3
            };
        }

        if (!progress.videoUploaded) {
            return {
                action: 'upload_video',
                title: 'Record Video Introduction',
                description: 'Stand out with a video intro analyzed by AI',
                priority: 4
            };
        }

        return null;
    }
}

// Export singleton instance
export const onboardingService = new OnboardingService();

// Export types
export type { OnboardingProgress, UserOnboardingState };
